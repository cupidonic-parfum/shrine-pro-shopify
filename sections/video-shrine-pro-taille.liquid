{%- comment -%}
  Section vidéo — Shrine Pro (version étendue)
  - Vidéo Shopify OU YouTube/Vimeo
  - Taille ajustable (sm, md, lg, fill, origin)
  - Largeur pleine page activable
  - Autoplay + loop (optionnel)
  - Poster visible seulement si autoplay désactivé
{%- endcomment -%}

{%- assign is_full = section.settings.full_width -%}

<style>
  /* Wrapper principal */
  .kvv-video-{{ section.id }}{
    position:relative;
    isolation:isolate;
    overflow:hidden;
    color: {{ section.settings.text_color }};
    {%- if is_full -%}
      width:100vw;
      margin-left:calc(50% - 50vw);
      margin-right:calc(50% - 50vw);
      border-radius:0;
      box-shadow:none;
    {%- else -%}
      width:min(100%, var(--page-width, 1200px));
      margin-inline:auto;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      margin-block:clamp(16px, 3vw, 32px);
    {%- endif -%}
  }

  /* Conteneur média */
  .kvv-media-{{ section.id }}{
    position:relative;
    background:#000;
  }

  /* Ratio par défaut */
  .kvv-media-{{ section.id }}::before{
    content:"";
    display:block;
    width:100%;
    padding-top:56.25%; /* 16/9 */
  }

  /* ---- OPTIONS DE TAILLE ---- */
  {%- case section.settings.video_size -%}
    {%- when 'sm' -%}
      .kvv-media-{{ section.id }}::before{ padding-top:40%; }
    {%- when 'md' -%}
      .kvv-media-{{ section.id }}::before{ padding-top:50%; }
    {%- when 'lg' -%}
      .kvv-media-{{ section.id }}::before{ padding-top:60%; }
    {%- when 'fill' -%}
      .kvv-media-{{ section.id }}{ min-height:60vh; }
      .kvv-media-{{ section.id }}::before{ padding-top:0; }
      .kvv-media-{{ section.id }} > .kvv-el{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    {%- when 'origin' -%}
      /* Taille d’origine (Shopify video uniquement) */
      .kvv-media-{{ section.id }}.kvv-has-shopify::before{ display:none; padding-top:0; }
      .kvv-media-{{ section.id }}.kvv-has-shopify{ height:auto; }
      .kvv-media-{{ section.id }}.kvv-has-shopify > .kvv-video{
        position:static; width:100%; height:auto; object-fit:contain; display:block;
      }
      /* Fallback pour externes */
      .kvv-media-{{ section.id }}.kvv-has-external::before{ padding-top:56.25%; }
      .kvv-media-{{ section.id }} > .kvv-iframe{ position:absolute; inset:0; width:100%; height:100%; }
  {%- endcase -%}

  /* Éléments médias */
  .kvv-el{ position:absolute; inset:0; width:100%; height:100%; border:0; display:block; object-fit:cover; }
  .kvv-iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; display:block; }

  /* Poster */
  .kvv-poster{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    display:block;
    transition:opacity .25s ease;
  }
  .kvv-poster.is-hidden{ opacity:0; pointer-events:none; }

  /* Overlay */
  .kvv-overlay-{{ section.id }}{
    position:absolute; inset:0;
    background: rgba({{ section.settings.overlay_color.red }}, {{ section.settings.overlay_color.green }}, {{ section.settings.overlay_color.blue }}, {{ section.settings.overlay_opacity | divided_by: 100.0 }});
    pointer-events:none;
  }

  /* Contenu centré */
  .kvv-center{
    position:absolute; inset:0;
    display:grid; place-items:center; text-align:center;
    padding:clamp(16px, 4vw, 48px);
    pointer-events:none;
  }
  .kvv-prose{ pointer-events:auto; max-width:min(90ch, 90%); margin-inline:auto; }

  .kvv-sub{ font-weight:700; margin:0 0 .5rem; opacity:.9; }
  .kvv-h{ margin:.25rem 0 .75rem; font-weight:800; line-height:1.1; }
  .kvv-h.h0{ font-size:clamp(32px, 6vw, 56px); }
  .kvv-h.h1{ font-size:clamp(28px, 5vw, 44px); }

  .kvv-rich :where(p){ margin:0 0 .75rem; }
  .kvv-rich :where(a){ text-decoration:underline; }

  /* Boutons */
  .kvv-btn{
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:999px; font-weight:700;
    padding:.9rem 1.25rem; border:2px solid currentColor;
    text-decoration:none; gap:.5rem;
  }
  .kvv-btn.fill{ background:var(--btn-bg,#111); color:var(--btn-fg,#fff); border-color:transparent; }
  .kvv-btn.outline{ background:transparent; color:currentColor; }

  /* Bouton lecture */
  .kvv-play{
    display:inline-grid; place-items:center;
    width:64px; height:64px; border-radius:50%;
    background:rgba(255,255,255,.2);
    border:2px solid rgba(255,255,255,.7);
    backdrop-filter:blur(4px);
    margin:0 auto 1rem;
    transition:transform .15s ease;
  }
  .kvv-play:hover{ transform:scale(1.05); }
  .kvv-play svg{ width:28px; height:28px; fill:#fff; }
</style>

<section class="kvv-video-{{ section.id }}">
  <div class="kvv-media-{{ section.id }} {% if section.settings.video != blank %}kvv-has-shopify{% else %}kvv-has-external{% endif %}">
    {%- assign poster_image = section.settings.poster | default: section.settings.video.preview_image -%}

    {%- assign show_controls = true -%}
    {%- if section.settings.autoplay -%}{% assign show_controls = false %}{%- endif -%}

    {%- if section.settings.video != blank -%}
      {{ section.settings.video | video_tag:
        playsinline: true,
        preload: 'metadata',
        muted: section.settings.autoplay,
        loop: section.settings.autoplay,
        autoplay: section.settings.autoplay,
        controls: show_controls,
        class: 'kvv-el kvv-video',
        image_size: '800x'
      }}
      {%- unless section.settings.autoplay -%}
        {%- if poster_image != blank -%}
          {{ poster_image | image_url: width: poster_image.width | image_tag: class: 'kvv-poster', loading: 'lazy', sizes: '100vw', widths: '600,800,1000,1400,1800,2200,2600,3000,3200' }}
        {%- endif -%}
      {%- endunless -%}
    {%- else -%}
      {%- if section.settings.external_video_url.type == 'youtube' -%}
        <iframe class="kvv-iframe"
          src="https://www.youtube.com/embed/{{ section.settings.external_video_url.id }}?playsinline=1&{% if section.settings.autoplay %}autoplay=1&mute=1&loop=1&controls=0&{% endif %}playlist={{ section.settings.external_video_url.id }}&rel=0&modestbranding=1"
          allow="autoplay; encrypted-media" allowfullscreen></iframe>
      {%- elsif section.settings.external_video_url.type == 'vimeo' -%}
        <iframe class="kvv-iframe"
          src="https://player.vimeo.com/video/{{ section.settings.external_video_url.id }}?{% if section.settings.autoplay %}background=1&autoplay=1&muted=1&loop=1&{% endif %}title=0&byline=0&portrait=0"
          allow="autoplay; encrypted-media" allowfullscreen></iframe>
      {%- endif -%}
      {%- unless section.settings.autoplay -%}
        {%- if poster_image != blank -%}
          {{ poster_image | image_url: width: poster_image.width | image_tag: class: 'kvv-poster', loading: 'lazy', sizes: '100vw', widths: '600,800,1000,1400,1800,2200,2600,3000,3200' }}
        {%- endif -%}
      {%- endunless -%}
    {%- endif -%}

    <div class="kvv-overlay-{{ section.id }}"></div>

    {%- if section.blocks.size > 0 -%}
      <div class="kvv-center">
        <div class="kvv-prose" style="--btn-bg: {{ section.settings.button_bg }}; --btn-fg: {{ section.settings.button_text }};">
          {%- for block in section.blocks -%}
            {%- case block.type -%}
              {%- when 'play' -%}
                {%- unless section.settings.autoplay -%}
                  <button class="kvv-play" type="button" onclick="
                    (function(root){
                      var v=root.querySelector('video.kvv-video');
                      if(v){try{v.muted=false;v.play();}catch(e){}}
                      var p=root.querySelector('.kvv-poster');if(p){p.classList.add('is-hidden');setTimeout(()=>p.remove(),200);}
                      event.currentTarget.remove();
                    })(event.currentTarget.closest('.kvv-media-{{ section.id }}'));
                  ">
                    <svg viewBox='0 0 24 24'><path d='M8 5v14l11-7z'/></svg>
                  </button>
                {%- endunless -%}
              {%- when 'subheading' -%}
                {%- if block.settings.text != blank -%}<p class="kvv-sub">{{ block.settings.text }}</p>{%- endif -%}
              {%- when 'heading' -%}
                {%- if block.settings.text != blank -%}<p class="kvv-h {{ block.settings.heading_tag }}">{{ block.settings.text }}</p>{%- endif -%}
              {%- when 'richtext' -%}
                {%- if block.settings.content != blank -%}<div class="kvv-rich">{{ block.settings.content }}</div>{%- endif -%}
              {%- when 'button' -%}
                {%- if block.settings.text != blank -%}
                  <a href="{{ block.settings.url | default: '#' }}" class="kvv-btn {{ block.settings.style }} {{ block.settings.size }}" style="--btn-bg:{{ block.settings.background | default: section.settings.button_bg }};--btn-fg:{{ block.settings.text_color | default: section.settings.button_text }};">{{ block.settings.text }}</a>
                {%- endif -%}
            {%- endcase -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  </div>
</section>

{% schema %}
{
  "name": "Video",
  "tag": "section",
  "settings": [
    { "type": "checkbox", "id": "full_width", "label": "Full width (edge-to-edge)", "default": false },
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay (muted + loop)", "default": false },
    {
      "type": "select",
      "id": "video_size",
      "label": "Video size",
      "info": "“Original size” respecte le ratio intrinsèque des vidéos Shopify. Pour YouTube/Vimeo, le rendu reste en 16/9.",
      "options": [
        { "value": "auto", "label": "16/9 (recommended)" },
        { "value": "sm", "label": "Small" },
        { "value": "md", "label": "Medium" },
        { "value": "lg", "label": "Large" },
        { "value": "fill", "label": "Fill screen" },
        { "value": "origin", "label": "Original size (Shopify video)" }
      ],
      "default": "auto"
    },
    { "type": "video", "id": "video", "label": "Video (Shopify file)" },
    { "type": "video_url", "id": "external_video_url", "accept": ["youtube", "vimeo"], "label": "Video URL" },
    { "type": "image_picker", "id": "poster", "label": "Poster image" },
    { "type": "header", "content": "Colors" },
    { "type": "color", "id": "text_color", "label": "Text", "default": "#ffffff" },
    { "type": "color", "id": "overlay_color", "label": "Overlay", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 30 },
    { "type": "header", "content": "Buttons default colors" },
    { "type": "color", "id": "button_bg", "label": "Button background", "default": "#111111" },
    { "type": "color", "id": "button_text", "label": "Button text", "default": "#ffffff" }
  ],
  "blocks": [
    { "type": "play", "name": "Play button", "limit": 1 },
    { "type": "subheading", "name": "Subheading", "settings": [{ "type": "text", "id": "text", "label": "Text" }] },
    { "type": "heading", "name": "Heading", "settings": [{ "type": "text", "id": "text", "label": "Text" }, { "type": "select", "id": "heading_tag", "label": "Style", "options": [{ "value": "h0", "label": "H0" }, { "value": "h1", "label": "H1" }, { "value": "h2", "label": "H2" }], "default": "h1" }] },
    { "type": "richtext", "name": "Paragraph", "settings": [{ "type": "richtext", "id": "content", "label": "Content" }] },
    {
      "type": "button",
      "name": "Button",
      "settings": [
        { "type": "text", "id": "text", "label": "Text" },
        { "type": "url", "id": "url", "label": "Link" },
        { "type": "select", "id": "style", "label": "Style", "options": [{ "value": "outline", "label": "Outline" }, { "value": "fill", "label": "Fill" }], "default": "outline" },
        { "type": "select", "id": "size", "label": "Size", "options": [{ "value": "sm", "label": "Small" }, { "value": "base", "label": "Medium" }, { "value": "lg", "label": "Large" }], "default": "lg" },
        { "type": "color", "id": "background", "label": "Background (fill only)" },
        { "type": "color", "id": "text_color", "label": "Text (fill only)" }
      ]
    }
  ],
  "presets": [{ "name": "Video" }]
}
{% endschema %}
